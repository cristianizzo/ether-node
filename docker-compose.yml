version: "3.8"

services:
  # Ethereum Geth Node Configuration
  geth:
    image: ethereum/client-go:stable
    pull_policy: always
    container_name: geth
    restart: unless-stopped
    ports:
      - "8545:8545"  # JSON-RPC HTTP service
      - "8546:8546"  # JSON-RPC WebSocket service
      - "8551:8551"  # Execution client API (used by beacon chain)
      - "30303:30303"  # P2P communication
      - "30303:30303/udp"  # P2P communication (UDP)
    volumes:
      - /geth-data:/data/.geth-data
    stop_signal: SIGINT
    stop_grace_period: 2m
    healthcheck:
      test: [ "CMD-SHELL", "geth version" ]
      interval: 10s
      timeout: 5s
      retries: 5
    command:
      [
        # Blockchain sync mode ("snap", "full" or "light")
        "--syncmode=full",
        # Megabytes of memory allocated to internal caching
        "--cache=8192",
        # Enable the WS-RPC server
        "--ws",
        "--ws.origins=*",
        "--ws.addr=0.0.0.0",
        "--ws.api=eth,net,web3",
        # Enable the HTTP-RPC server
        "--http",
        "--http.api=eth,net,web3,engine,admin,metrics",
        "--http.addr=0.0.0.0",
        "--http.vhosts=*",
        "--http.corsdomain=*",
        # Enable GraphQL on the HTTP-RPC server. Note that GraphQL can only be started if an HTTP server is started as well.
        "--graphql",
        "--graphql.corsdomain=*",
        "--graphql.vhosts=*",
        # Enable RPC server
        "--authrpc.addr=0.0.0.0",
        "--authrpc.vhosts=*",
        "--authrpc.jwtsecret=/data/.geth-data/jwt.hex",
        "--authrpc.port=8551",
        # Enable metrics collection and reporting
        "--metrics",
        # Ethereum mainnet
        "--mainnet",
        "--ipcpath=/data/.geth-data/geth.ipc"
      ]

  # Prysm Beacon Chain Configuration
  beacon:
    image: gcr.io/prysmaticlabs/prysm/beacon-chain:stable
    pull_policy: always
    container_name: beacon
    restart: unless-stopped
    stop_grace_period: 2m
    volumes:
      - /beacon-data:/data/.beacon-data
    depends_on:
      geth:
        condition: service_healthy
    ports:
      - "4000:4000"  # gRPC server for Prysm
      - "13000:13000"  # P2P communication for Prysm
      - "12000:12000/udp"  # P2P communication for Prysm UDP
    command:
      [
        "--accept-terms-of-use",
        "--disable-monitoring",
        "--rpc-host=0.0.0.0",
        "--monitoring-host=0.0.0.0",
        "--execution-endpoint=http://geth:8551",
        "--jwt-secret=/data/.geth-data/jwt.hex",
        "--rpc-host=0.0.0.0",
        "--rpc-port=4000",
        "--grpc-gateway-corsdomain=*",
        "--grpc-gateway-host=0.0.0.0",
        "--grpc-gateway-port=3500"
      ]

  prometheus:
    image: prom/prometheus
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus-data:/prometheus/prometheus.yml
    restart: unless-stopped

  grafana:
    build: ./grafana
    ports:
      - "3000:3000"  # Grafana web interface
    depends_on:
      - prometheus
    environment:
      - GF_SERVER_HTTP_PORT=3000
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - ./grafana-data:/var/lib/grafana
    restart: unless-stopped

volumes:
  geth:
    driver: local
  beacon:
    driver: local
  grafana-storage:
    driver: local
  prometheus-storage:
    driver: local
